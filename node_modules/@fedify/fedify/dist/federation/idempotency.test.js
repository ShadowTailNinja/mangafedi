
      import { Temporal } from "@js-temporal/polyfill";
      import { URLPattern } from "urlpattern-polyfill";
      globalThis.addEventListener = () => {};
    
import { Create, Follow, Person } from "../type-BVpqRkFR.js";
import { assertEquals } from "../assert_equals-DSbWqCm3.js";
import "../assert-MZs1qjMx.js";
import "../assert_instance_of-DHz7EHNU.js";
import { MemoryKvStore } from "../kv-QzKcOQgP.js";
import { createFederation } from "../middleware-CmaZY01E.js";
import "../semver-dArNLkR9.js";
import "../client-BTEYHgMp.js";
import "../lookup-CyI7sF0p.js";
import "../types-BIgY6c-l.js";
import "../actor-BdLqN1gg.js";
import "../key-DrXt0cYP.js";
import "../http-DplZ1SHu.js";
import "../authdocloader-CLAhEwIS.js";
import "../ld-DzleVPgo.js";
import "../owner-n8GJaHF9.js";
import { signObject } from "../proof-D7qegtQm.js";
import "../inbox-BxnmUryw.js";
import "../builder-4kTkpLYJ.js";
import "../collection-CSzG2j1P.js";
import "../keycache-Cm9Ke5JM.js";
import "../retry-D4GJ670a.js";
import "../send-CcNf5O--.js";
import { mockDocumentLoader, test } from "../testing-DoQEBY_a.js";
import "../std__assert-X-_kMxKM.js";
import "../assert_rejects-DiIiJbZn.js";
import "../assert_is_error-BPGph1Jx.js";
import "../assert_not_equals-f3m3epl3.js";
import "../assert_throws-BOO88avQ.js";
import { ed25519Multikey, ed25519PrivateKey, ed25519PublicKey } from "../keys-C6gRMT25.js";

//#region src/federation/idempotency.test.ts
const kv = new MemoryKvStore();
const federationOptions = {
	kv,
	documentLoader: mockDocumentLoader,
	authenticatedDocumentLoaderFactory: () => mockDocumentLoader
};
function createTestFederation() {
	const federation = createFederation(federationOptions);
	federation.setActorDispatcher("/users/{identifier}", (_, identifier) => identifier === "john" ? new Person({}) : null).setKeyPairsDispatcher(() => [{
		privateKey: ed25519PrivateKey,
		publicKey: ed25519PublicKey.publicKey
	}]);
	return federation;
}
test("Federation.setInboxListeners().withIdempotency() - per-origin strategy", async () => {
	const federation = createTestFederation();
	const processedActivities = [];
	federation.setInboxListeners("/users/{identifier}/inbox", "/inbox").withIdempotency("per-origin").on(Create, (ctx, activity$1) => {
		processedActivities.push([ctx.recipient, activity$1]);
	});
	const activity = new Create({
		id: new URL("https://example.com/activities/1"),
		actor: new URL("https://example.com/person2")
	});
	const signedActivity = await signObject(activity, ed25519PrivateKey, ed25519Multikey.id);
	const body = JSON.stringify(await signedActivity.toJsonLd({ contextLoader: mockDocumentLoader }));
	let response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
	assertEquals(processedActivities[0][0], "john");
	response = await federation.fetch(new Request("https://example.com/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
	await kv.delete([
		"_fedify",
		"activityIdempotence",
		"https://example.com:https://example.com/activities/1"
	]);
});
test("Federation.setInboxListeners().withIdempotency() - per-inbox strategy", async () => {
	const federation = createTestFederation();
	const processedActivities = [];
	federation.setInboxListeners("/users/{identifier}/inbox", "/inbox").withIdempotency("per-inbox").on(Create, (ctx, activity$1) => {
		processedActivities.push([ctx.recipient, activity$1]);
	});
	const activity = new Create({
		id: new URL("https://example.com/activities/2"),
		actor: new URL("https://example.com/person2")
	});
	const signedActivity = await signObject(activity, ed25519PrivateKey, ed25519Multikey.id);
	const body = JSON.stringify(await signedActivity.toJsonLd({ contextLoader: mockDocumentLoader }));
	let response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
	assertEquals(processedActivities[0][0], "john");
	response = await federation.fetch(new Request("https://example.com/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 2);
	assertEquals(processedActivities[1][0], null);
	response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 2);
});
test("Federation.setInboxListeners().withIdempotency() - global strategy", async () => {
	const federation = createTestFederation();
	const processedActivities = [];
	federation.setInboxListeners("/users/{identifier}/inbox", "/inbox").withIdempotency("global").on(Create, (ctx, activity$1) => {
		processedActivities.push([ctx.recipient, activity$1]);
	});
	const activity = new Create({
		id: new URL("https://example.com/activities/3"),
		actor: new URL("https://example.com/person2")
	});
	const signedActivity = await signObject(activity, ed25519PrivateKey, ed25519Multikey.id);
	const body = JSON.stringify(await signedActivity.toJsonLd({ contextLoader: mockDocumentLoader }));
	let response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
	response = await federation.fetch(new Request("https://example.com/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
});
test("Federation.setInboxListeners().withIdempotency() - custom callback", async () => {
	const federation = createTestFederation();
	const processedActivities = [];
	federation.setInboxListeners("/users/{identifier}/inbox", "/inbox").withIdempotency((ctx, activity) => {
		if (activity instanceof Follow) return null;
		const inboxId = ctx.recipient ?? "shared";
		return `${ctx.origin}:${activity.id?.href}:${inboxId}`;
	}).on(Create, (ctx, activity) => {
		processedActivities.push([ctx.recipient, activity]);
	}).on(Follow, (ctx, activity) => {
		processedActivities.push([ctx.recipient, activity]);
	});
	const createActivity = new Create({
		id: new URL("https://example.com/activities/4"),
		actor: new URL("https://example.com/person2")
	});
	const signedCreate = await signObject(createActivity, ed25519PrivateKey, ed25519Multikey.id);
	const createBody = JSON.stringify(await signedCreate.toJsonLd({ contextLoader: mockDocumentLoader }));
	let response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body: createBody
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
	response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body: createBody
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 1);
	const followActivity = new Follow({
		id: new URL("https://example.com/activities/5"),
		actor: new URL("https://example.com/person2")
	});
	const signedFollow = await signObject(followActivity, ed25519PrivateKey, ed25519Multikey.id);
	const followBody = JSON.stringify(await signedFollow.toJsonLd({ contextLoader: mockDocumentLoader }));
	response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body: followBody
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 2);
	response = await federation.fetch(new Request("https://example.com/users/john/inbox", {
		method: "POST",
		headers: { "Content-Type": "application/activity+json" },
		body: followBody
	}), { contextData: void 0 });
	assertEquals(response.status, 202);
	assertEquals(processedActivities.length, 3);
});

//#endregion